pool:
  vmImage: 'windows-latest'

#variables:
# - group: 'code-signing'
  
steps:
- task: UseDotNet@2
  inputs:
    version: 6.0.416
  displayName: Install .NET Core SDK 6.0.416

- task: UseDotNet@2
  inputs:
    version: 7.0.403
  displayName: Install .NET Core SDK 7.0.403

- task: NuGetAuthenticate@0
  displayName: Authenticate with NuGet feeds

- script: dotnet pack -c Release /p:PublicRelease=false
  displayName: Create NuGet packages
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Schedule'))

- script: dotnet pack -c Release /p:PublicRelease=true
  displayName: Create NuGet packages
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual'))

- pwsh: >
    dotnet tool install --tool-path obj SignClient

    obj/SignClient sign
    --baseDirectory '$(Build.ArtifactStagingDirectory)/bin'
    --input '**/*.nupkg'
    --config '$(System.DefaultWorkingDirectory)/eng/signclient.json'
    --user '$(codesign_username)'
    --secret '$(codesign_secret)'
    --name 'Coverlet'
    --descriptionUrl 'https://github.com/coverlet-coverage/coverlet'
  displayName: üîè Code sign
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual')))
  enabled: false

- task: NuGetCommand@2
  inputs:
    command: push
    packagesToPush: $(Build.SourcesDirectory)/bin/Release/Packages/*.nupkg
    nuGetFeedType: internal
    publishVstsFeed: coverlet/coverlet-nightly
  displayName: Publish NuGet packages

- task: NuGetCommand@2
  inputs:
    command: push
    packagesToPush: $(Build.SourcesDirectory)/bin/Release/Packages/*.snupkg
    nuGetFeedType: internal
    publishVstsFeed: coverlet/coverlet-nightly
  displayName: Publish NuGet symbol packages
